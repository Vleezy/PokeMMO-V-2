"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[299],{7299:function(t,e,i){i.r(e),i.d(e,{CharacterShiftAction:function(){return er},CollisionStrategy:function(){return tW},Direction:function(){return w},GridEngine:function(){return ec},GridEngineHeadless:function(){return en},MoveToResult:function(){return t2},NoPathFoundStrategy:function(){return t$},NumberOfDirections:function(){return E},PathBlockedStrategy:function(){return tj},PhaserTile:function(){return ea},PhaserTileLayer:function(){return eh},PhaserTilemap:function(){return el},default:function(){return eu}});var r,n,s,o,a,h,l,c=Object.defineProperty,u=Object.defineProperties,d=Object.getOwnPropertyDescriptors,p=Object.getOwnPropertySymbols,g=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,m=(t,e,i)=>e in t?c(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,y=(t,e)=>{for(var i in e||(e={}))g.call(e,i)&&m(t,i,e[i]);if(p)for(var i of p(e))f.call(e,i)&&m(t,i,e[i]);return t},v=(t,e)=>u(t,d(e)),T=class{static get ZERO(){return new T(0,0)}static get ONE(){return new T(1,1)}static get UP(){return new T(0,-1)}static get DOWN(){return new T(0,1)}static get LEFT(){return new T(-1,0)}static get RIGHT(){return new T(1,0)}static get UP_LEFT(){return new T(-1,-1)}static get UP_RIGHT(){return new T(1,-1)}static get DOWN_RIGHT(){return new T(1,1)}static get DOWN_LEFT(){return new T(-1,1)}constructor(t,e){"number"==typeof t?(this.x=t,this.y=e||0):(this.x=t.x,this.y=t.y)}clone(){return new T(this.x,this.y)}add(t){return new T(this.x+t.x,this.y+t.y)}multiply(t){return new T(this.x*t.x,this.y*t.y)}divide(t){return new T(this.x/t.x,this.y/t.y)}subtract(t){return new T(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}abs(){return new T(Math.abs(this.x),Math.abs(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}modulo(t){return new T(this.x%t.x,this.y%t.y)}scalarModulo(t){return new T(this.x%t,this.y%t)}scalarMult(t){return new T(this.x*t,this.y*t)}toPosition(){return{x:this.x,y:this.y}}toString(){return`${this.x}#${this.y}`}},P=class{static equal(t,e){return t.position.x===e.position.x&&t.position.y===e.position.y&&t.layer===e.layer}static copyOver(t,e){e.position.x=t.position.x,e.position.y=t.position.y,e.layer=t.layer}static clone(t){return{position:t.position.clone(),layer:t.layer}}static toString(t){return`${t.position.toString()}#${t.layer}`}static toInternal(t){return{position:new T(t.position.x,t.position.y),layer:t.charLayer}}static fromInternal(t){return{position:t.position.toPosition(),charLayer:t.layer}}},w=((r=w||{}).NONE="none",r.LEFT="left",r.UP_LEFT="up-left",r.UP="up",r.UP_RIGHT="up-right",r.RIGHT="right",r.DOWN_RIGHT="down-right",r.DOWN="down",r.DOWN_LEFT="down-left",r);function C(t){return["down-left","down-right","up-right","up-left"].includes(t)}function b(t){return({up:T.UP,down:T.DOWN,left:T.LEFT,right:T.RIGHT,none:T.ZERO,"up-left":T.UP_LEFT,"up-right":T.UP_RIGHT,"down-right":T.DOWN_RIGHT,"down-left":T.DOWN_LEFT})[t]}function S(t){return({up:"down",down:"up",left:"right",right:"left",none:"none","up-left":"down-right","up-right":"down-left","down-right":"up-left","down-left":"up-right"})[t]}var E=((n=E||{})[n.FOUR=4]="FOUR",n[n.EIGHT=8]="EIGHT",n),x=function(t,e){return(x=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};function O(t,e){if("function"!=typeof e&&null!==e)throw TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}x(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function _(t,e){var i,r,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(h){return function(a){if(i)throw TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(i=1,r&&(n=2&a[0]?r.return:a[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,a[1])).done)return n;switch(r=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(n=(n=o.trys).length>0&&n[n.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){o.label=a[1];break}if(6===a[0]&&o.label<n[1]){o.label=n[1],n=a;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(a);break}n[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],r=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,h])}}}function D(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function L(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,s=i.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(t){n={error:t}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return o}function M(t,e,i){if(i||2==arguments.length)for(var r,n=0,s=e.length;n<s;n++)!r&&n in e||(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return t.concat(r||Array.prototype.slice.call(e))}function A(t){return this instanceof A?(this.v=t,this):new A(t)}function k(t){return"function"==typeof t}function I(t){var e=t(function(t){Error.call(t),t.stack=Error().stack});return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var R=I(function(t){return function(e){t(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(t,e){return e+1+") "+t.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function H(t,e){if(t){var i=t.indexOf(e);0<=i&&t.splice(i,1)}}var F=function(){var t;function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,e,i,r,n;if(!this.closed){this.closed=!0;var s=this._parentage;if(s){if(this._parentage=null,Array.isArray(s))try{for(var o=D(s),a=o.next();!a.done;a=o.next())a.value.remove(this)}catch(e){t={error:e}}finally{try{a&&!a.done&&(e=o.return)&&e.call(o)}finally{if(t)throw t.error}}else s.remove(this)}var h=this.initialTeardown;if(k(h))try{h()}catch(t){n=t instanceof R?t.errors:[t]}var l=this._finalizers;if(l){this._finalizers=null;try{for(var c=D(l),u=c.next();!u.done;u=c.next()){var d=u.value;try{G(d)}catch(t){n=null!=n?n:[],t instanceof R?n=M(M([],L(n)),L(t.errors)):n.push(t)}}}catch(t){i={error:t}}finally{try{u&&!u.done&&(r=c.return)&&r.call(c)}finally{if(i)throw i.error}}}if(n)throw new R(n)}},e.prototype.add=function(t){var i;if(t&&t!==this){if(this.closed)G(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(i=this._finalizers)&&void 0!==i?i:[]).push(t)}}},e.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},e.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},e.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&H(e,t)},e.prototype.remove=function(t){var i=this._finalizers;i&&H(i,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}(),B=F.EMPTY;function N(t){return t instanceof F||t&&"closed"in t&&k(t.remove)&&k(t.add)&&k(t.unsubscribe)}function G(t){k(t)?t():t.unsubscribe()}var W={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},$={setTimeout:function(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var n=$.delegate;return null!=n&&n.setTimeout?n.setTimeout.apply(n,M([t,e],L(i))):setTimeout.apply(void 0,M([t,e],L(i)))},clearTimeout:function(t){var e=$.delegate;return((null==e?void 0:e.clearTimeout)||clearTimeout)(t)},delegate:void 0};function U(t){$.setTimeout(function(){var e=W.onUnhandledError;if(e)e(t);else throw t})}function z(){}var q=X("C",void 0,void 0);function X(t,e,i){return{kind:t,value:e,error:i}}var Y=null;function j(t){if(W.useDeprecatedSynchronousErrorHandling){var e=!Y;if(e&&(Y={errorThrown:!1,error:null}),t(),e){var i=Y,r=i.errorThrown,n=i.error;if(Y=null,r)throw n}}else t()}var K=function(t){function e(e){var i=t.call(this)||this;return i.isStopped=!1,e?(i.destination=e,N(e)&&e.add(i)):i.destination=ti,i}return O(e,t),e.create=function(t,e,i){return new Q(t,e,i)},e.prototype.next=function(t){this.isStopped?te(X("N",t,void 0),this):this._next(t)},e.prototype.error=function(t){this.isStopped?te(X("E",void 0,t),this):(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped?te(q,this):(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(F),V=Function.prototype.bind;function Z(t,e){return V.call(t,e)}var J=function(){function t(t){this.partialObserver=t}return t.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(t){tt(t)}},t.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(t){tt(t)}else tt(t)},t.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(t){tt(t)}},t}(),Q=function(t){function e(e,i,r){var n,s,o=t.call(this)||this;return k(e)||!e?s={next:null!=e?e:void 0,error:null!=i?i:void 0,complete:null!=r?r:void 0}:o&&W.useDeprecatedNextContext?((n=Object.create(e)).unsubscribe=function(){return o.unsubscribe()},s={next:e.next&&Z(e.next,n),error:e.error&&Z(e.error,n),complete:e.complete&&Z(e.complete,n)}):s=e,o.destination=new J(s),o}return O(e,t),e}(K);function tt(t){W.useDeprecatedSynchronousErrorHandling?W.useDeprecatedSynchronousErrorHandling&&Y&&(Y.errorThrown=!0,Y.error=t):U(t)}function te(t,e){var i=W.onStoppedNotification;i&&$.setTimeout(function(){return i(t,e)})}var ti={closed:!0,next:z,error:function(t){throw t},complete:z},tr="function"==typeof Symbol&&Symbol.observable||"@@observable";function tn(t){return t}function ts(t){return 0===t.length?tn:1===t.length?t[0]:function(e){return t.reduce(function(t,e){return e(t)},e)}}var to=function(){function t(t){t&&(this._subscribe=t)}return t.prototype.lift=function(e){var i=new t;return i.source=this,i.operator=e,i},t.prototype.subscribe=function(t,e,i){var r,n=this,s=(r=t)&&r instanceof K||r&&k(r.next)&&k(r.error)&&k(r.complete)&&N(r)?t:new Q(t,e,i);return j(function(){var t=n.operator,e=n.source;s.add(t?t.call(s,e):e?n._subscribe(s):n._trySubscribe(s))}),s},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},t.prototype.forEach=function(t,e){var i=this;return new(e=ta(e))(function(e,r){var n=new Q({next:function(e){try{t(e)}catch(t){r(t),n.unsubscribe()}},error:r,complete:e});i.subscribe(n)})},t.prototype._subscribe=function(t){var e;return null===(e=this.source)||void 0===e?void 0:e.subscribe(t)},t.prototype[tr]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return ts(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=ta(t))(function(t,i){var r;e.subscribe(function(t){return r=t},function(t){return i(t)},function(){return t(r)})})},t.create=function(e){return new t(e)},t}();function ta(t){var e;return null!==(e=null!=t?t:W.Promise)&&void 0!==e?e:Promise}function th(t){return function(e){if(k(null==e?void 0:e.lift))return e.lift(function(e){try{return t(e,this)}catch(t){this.error(t)}});throw TypeError("Unable to lift unknown Observable type")}}function tl(t,e,i,r,n){return new tc(t,e,i,r,n)}var tc=function(t){function e(e,i,r,n,s,o){var a=t.call(this,e)||this;return a.onFinalize=s,a.shouldUnsubscribe=o,a._next=i?function(t){try{i(t)}catch(t){e.error(t)}}:t.prototype._next,a._error=n?function(t){try{n(t)}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._error,a._complete=r?function(){try{r()}catch(t){e.error(t)}finally{this.unsubscribe()}}:t.prototype._complete,a}return O(e,t),e.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;t.prototype.unsubscribe.call(this),i||null===(e=this.onFinalize)||void 0===e||e.call(this)}},e}(K),tu=I(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),td=function(t){function e(){var e=t.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return O(e,t),e.prototype.lift=function(t){var e=new tp(this,this);return e.operator=t,e},e.prototype._throwIfClosed=function(){if(this.closed)throw new tu},e.prototype.next=function(t){var e=this;j(function(){var i,r;if(e._throwIfClosed(),!e.isStopped){e.currentObservers||(e.currentObservers=Array.from(e.observers));try{for(var n=D(e.currentObservers),s=n.next();!s.done;s=n.next())s.value.next(t)}catch(t){i={error:t}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}}})},e.prototype.error=function(t){var e=this;j(function(){if(e._throwIfClosed(),!e.isStopped){e.hasError=e.isStopped=!0,e.thrownError=t;for(var i=e.observers;i.length;)i.shift().error(t)}})},e.prototype.complete=function(){var t=this;j(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var e=t.observers;e.length;)e.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return(null===(t=this.observers)||void 0===t?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(e){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,e)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var e=this,i=this.hasError,r=this.isStopped,n=this.observers;return i||r?B:(this.currentObservers=null,n.push(t),new F(function(){e.currentObservers=null,H(n,t)}))},e.prototype._checkFinalizedStatuses=function(t){var e=this.hasError,i=this.thrownError,r=this.isStopped;e?t.error(i):r&&t.complete()},e.prototype.asObservable=function(){var t=new to;return t.source=this,t},e.create=function(t,e){return new tp(t,e)},e}(to),tp=function(t){function e(e,i){var r=t.call(this)||this;return r.destination=e,r.source=i,r}return O(e,t),e.prototype.next=function(t){var e,i;null===(i=null===(e=this.destination)||void 0===e?void 0:e.next)||void 0===i||i.call(e,t)},e.prototype.error=function(t){var e,i;null===(i=null===(e=this.destination)||void 0===e?void 0:e.error)||void 0===i||i.call(e,t)},e.prototype.complete=function(){var t,e;null===(e=null===(t=this.destination)||void 0===t?void 0:t.complete)||void 0===e||e.call(t)},e.prototype._subscribe=function(t){var e,i;return null!==(i=null===(e=this.source)||void 0===e?void 0:e.subscribe(t))&&void 0!==i?i:B},e}(td),tg=new to(function(t){return t.complete()});function tf(t){return t[t.length-1]}var tm=function(t){return t&&"number"==typeof t.length&&"function"!=typeof t};function ty(t){return k(null==t?void 0:t.then)}function tv(t){return Symbol.asyncIterator&&k(null==t?void 0:t[Symbol.asyncIterator])}function tT(t){return TypeError("You provided "+(null!==t&&"object"==typeof t?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var tP="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function tw(t){return k(null==t?void 0:t[tP])}function tC(t){return function(t,e,i){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var r,n=i.apply(t,e||[]),s=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(t){n[t]&&(r[t]=function(e){return new Promise(function(i,r){s.push([t,e,i,r])>1||a(t,e)})})}function a(t,e){try{var i;(i=n[t](e)).value instanceof A?Promise.resolve(i.value.v).then(h,l):c(s[0][2],i)}catch(t){c(s[0][3],t)}}function h(t){a("next",t)}function l(t){a("throw",t)}function c(t,e){t(e),s.shift(),s.length&&a(s[0][0],s[0][1])}}(this,arguments,function(){var e,i,r;return _(this,function(n){switch(n.label){case 0:e=t.getReader(),n.label=1;case 1:n.trys.push([1,,9,10]),n.label=2;case 2:return[4,A(e.read())];case 3:return r=(i=n.sent()).value,i.done?[4,A(void 0)]:[3,5];case 4:return[2,n.sent()];case 5:return[4,A(r)];case 6:return[4,n.sent()];case 7:return n.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function tb(t){return k(null==t?void 0:t.getReader)}function tS(t){if(t instanceof to)return t;if(null!=t){if(k(t[tr]))return new to(function(e){var i=t[tr]();if(k(i.subscribe))return i.subscribe(e);throw TypeError("Provided object does not correctly implement Symbol.observable")});if(tm(t))return new to(function(e){for(var i=0;i<t.length&&!e.closed;i++)e.next(t[i]);e.complete()});if(ty(t))return new to(function(e){t.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,U)});if(tv(t))return tE(t);if(tw(t))return new to(function(e){var i,r;try{for(var n=D(t),s=n.next();!s.done;s=n.next()){var o=s.value;if(e.next(o),e.closed)return}}catch(t){i={error:t}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}e.complete()});if(tb(t))return tE(tC(t))}throw tT(t)}function tE(t){return new to(function(e){(function(t,e){var i,r,n,s,o,a,h,l;return o=this,a=void 0,h=void 0,l=function(){var o;return _(this,function(a){switch(a.label){case 0:a.trys.push([0,5,6,11]),i=function(t){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var e,i=t[Symbol.asyncIterator];return i?i.call(t):(t=D(t),e={},r("next"),r("throw"),r("return"),e[Symbol.asyncIterator]=function(){return this},e);function r(i){e[i]=t[i]&&function(e){return new Promise(function(r,n){(function(t,e,i,r){Promise.resolve(r).then(function(e){t({value:e,done:i})},e)})(r,n,(e=t[i](e)).done,e.value)})}}}(t),a.label=1;case 1:return[4,i.next()];case 2:if((r=a.sent()).done)return[3,4];if(o=r.value,e.next(o),e.closed)return[2];a.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return n={error:a.sent()},[3,11];case 6:return a.trys.push([6,,9,10]),r&&!r.done&&(s=i.return)?[4,s.call(i)]:[3,8];case 7:a.sent(),a.label=8;case 8:return[3,10];case 9:if(n)throw n.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})},new(h||(h=Promise))(function(t,e){function i(t){try{n(l.next(t))}catch(t){e(t)}}function r(t){try{n(l.throw(t))}catch(t){e(t)}}function n(e){var n;e.done?t(e.value):((n=e.value)instanceof h?n:new h(function(t){t(n)})).then(i,r)}n((l=l.apply(o,a||[])).next())})})(t,e).catch(function(t){return e.error(t)})})}function tx(t,e,i,r,n){void 0===r&&(r=0),void 0===n&&(n=!1);var s=e.schedule(function(){i(),n?t.add(this.schedule(null,r)):this.unsubscribe()},r);if(t.add(s),!n)return s}function tO(t,e){return void 0===e&&(e=0),th(function(i,r){i.subscribe(tl(r,function(i){return tx(r,t,function(){return r.next(i)},e)},function(){return tx(r,t,function(){return r.complete()},e)},function(i){return tx(r,t,function(){return r.error(i)},e)}))})}function t_(t,e){return void 0===e&&(e=0),th(function(i,r){r.add(t.schedule(function(){return i.subscribe(r)},e))})}function tD(t,e){if(!t)throw Error("Iterable cannot be null");return new to(function(i){tx(i,e,function(){var r=t[Symbol.asyncIterator]();tx(i,e,function(){r.next().then(function(t){t.done?i.complete():i.next(t.value)})},0,!0)})})}function tL(t,e){return th(function(i,r){var n=0;i.subscribe(tl(r,function(i){r.next(t.call(e,i,n++))}))})}var tM=Array.isArray;function tA(t,e){return th(function(i,r){var n=0;i.subscribe(tl(r,function(i){return t.call(e,i,n++)&&r.next(i)}))})}function tk(t){return t<=0?function(){return tg}:th(function(e,i){var r=0;e.subscribe(tl(i,function(e){++r<=t&&(i.next(e),t<=r&&i.complete())}))})}function tI(){for(var t,e,i,r,n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];var o=(e=tf(t=n))&&k(e.schedule)?t.pop():void 0,a="number"==typeof tf(i=n)?i.pop():1/0;return n=1===(r=n).length&&tM(r[0])?r[0]:r,th(function(t,e){var i,r;(void 0===(i=a)&&(i=1/0),function t(e,i,r){return void 0===r&&(r=1/0),k(i)?t(function(t,r){return tL(function(e,n){return i(t,e,r,n)})(tS(e(t,r)))},r):("number"==typeof i&&(r=i),th(function(t,i){var n,s,o,a,h,l,c,u,d,p,g,f;return n=r,l=[],c=0,u=0,d=!1,p=function(){!d||l.length||c||i.complete()},g=function(t){return c<n?f(t):l.push(t)},f=function(t){o&&i.next(t),c++;var r=!1;tS(e(t,u++)).subscribe(tl(i,function(t){null==s||s(t),o?g(t):i.next(t)},function(){r=!0},void 0,function(){if(r)try{for(c--;l.length&&c<n;)!function(){var t=l.shift();a?tx(i,a,function(){return f(t)}):f(t)}();p()}catch(t){i.error(t)}}))},t.subscribe(tl(i,g,function(){d=!0,p()})),function(){null==h||h()}}))}(tn,i))((r=M([t],L(n)),o?function(t,e){if(null!=t){if(k(t[tr]))return tS(t).pipe(t_(e),tO(e));if(tm(t))return new to(function(i){var r=0;return e.schedule(function(){r===t.length?i.complete():(i.next(t[r++]),i.closed||this.schedule())})});if(ty(t))return tS(t).pipe(t_(e),tO(e));if(tv(t))return tD(t,e);if(tw(t))return new to(function(i){var r;return tx(i,e,function(){r=t[tP](),tx(i,e,function(){var t,e,n;try{e=(t=r.next()).value,n=t.done}catch(t){i.error(t);return}n?i.complete():i.next(e)},0,!0)}),function(){return k(null==r?void 0:r.return)&&r.return()}});if(tb(t))return tD(tC(t),e)}throw tT(t)}(r,o):tS(r))).subscribe(e)})}function tR(t){return th(function(e,i){tS(t).subscribe(tl(i,function(){return i.complete()},z)),i.closed||e.subscribe(i)})}var tH=class{constructor(t,e){var i,r,n;this.id=t,this.movementDirection="none",this._tilePos={position:new T(0,0),layer:void 0},this.movementStarted$=new td,this.movementStopped$=new td,this.directionChanged$=new td,this.positionChangeStarted$=new td,this.positionChangeFinished$=new td,this.tilePositionSet$=new td,this.autoMovementSet$=new td,this.lastMovementImpulse="none",this.facingDirection="down",this.depthChanged$=new td,this.movementProgress=0,this.tilemap=e.tilemap,this.speed=e.speed,this.collidesWithTilesInternal=e.collidesWithTiles,this._tilePos.layer=e.charLayer,this.ignoreMissingTiles=null!=(i=e.ignoreMissingTiles)&&i,this.collisionGroups=new Set(e.collisionGroups||[]),this.labels=new Set(e.labels||[]),this.numberOfDirections=e.numberOfDirections,e.facingDirection&&this.turnTowards(e.facingDirection),this.tileWidth=null!=(r=e.tileWidth)?r:1,this.tileHeight=null!=(n=e.tileHeight)?n:1}getId(){return this.id}getSpeed(){return this.speed}setSpeed(t){this.speed=t}setMovement(t){this.autoMovementSet$.next(t),this.movement=t}getMovement(){return this.movement}collidesWithTiles(){return this.collidesWithTilesInternal}getIgnoreMissingTiles(){return this.ignoreMissingTiles}setTilePosition(t){this.isMoving()&&this.movementStopped$.next(this.movementDirection),this.tilePositionSet$.next(y({},t)),this.fire(this.positionChangeStarted$,this.tilePos,t),this.fire(this.positionChangeFinished$,this.tilePos,t),this.movementDirection="none",this.lastMovementImpulse="none",this.tilePos=t,this.movementProgress=0}getTilePos(){return this.tilePos}getNextTilePos(){if(!this.isMoving())return this.tilePos;let t=this.tilePos.layer,e=this.tilePosInDirection(this.tilePos.position,this.movementDirection),i=this.tilemap.getTransition(e,this.tilePos.layer);return i&&(t=i),{position:this.tilePosInDirection(this.tilePos.position,this.movementDirection),layer:t}}getTileWidth(){return this.tileWidth}getTileHeight(){return this.tileHeight}move(t){this.lastMovementImpulse=t,"none"!=t&&(this.isMoving()||(this.isBlockingDirection(t)?this.changeFacingDirection(t):this.startMoving(t)))}update(t){var e;null==(e=this.movement)||e.update(t),this.isMoving()&&this.updateCharacterPosition(t),this.lastMovementImpulse="none"}getMovementDirection(){return this.movementDirection}isBlockingDirection(t){if("none"==t)return!1;let e=this.tilePosInDirection(this.getNextTilePos().position,t),i=this.tilemap.getTransition(e,this.getNextTilePos().layer)||this.getNextTilePos().layer;return!!(this.collidesWithTilesInternal&&this.isTileBlocking(t,i))||this.isCharBlocking(t,i)}isTileBlocking(t,e){return this.someCharTile((i,r)=>{let n=this.tilePosInDirection(new T(i,r),t);return this.tilemap.hasBlockingTile(n,e,S(t),this.ignoreMissingTiles)})}isCharBlocking(t,e){return this.someCharTile((i,r)=>{let n=this.tilePosInDirection(new T(i,r),t);return this.tilemap.hasBlockingChar(n,e,this.getCollisionGroups(),new Set([this.getId()]))})}isMoving(){return"none"!=this.movementDirection}turnTowards(t){this.isMoving()||"none"!=t&&this.changeFacingDirection(t)}changeFacingDirection(t){this.facingDirection!==t&&(this.facingDirection=t,this.directionChanged$.next(t))}getFacingDirection(){return this.facingDirection}getFacingPosition(){return this._tilePos.position.add(b(this.facingDirection))}addCollisionGroup(t){this.collisionGroups.add(t)}setCollisionGroups(t){this.collisionGroups=new Set(t)}getCollisionGroups(){return Array.from(this.collisionGroups)}hasCollisionGroup(t){return this.collisionGroups.has(t)}removeCollisionGroup(t){this.collisionGroups.delete(t)}removeAllCollisionGroups(){this.collisionGroups.clear()}addLabels(t){for(let e of t)this.labels.add(e)}getLabels(){return[...this.labels.values()]}hasLabel(t){return this.labels.has(t)}clearLabels(){this.labels.clear()}removeLabels(t){for(let e of t)this.labels.delete(e)}getNumberOfDirections(){return this.numberOfDirections}movementStarted(){return this.movementStarted$}movementStopped(){return this.movementStopped$}directionChanged(){return this.directionChanged$}tilePositionSet(){return this.tilePositionSet$}positionChangeStarted(){return this.positionChangeStarted$}positionChangeFinished(){return this.positionChangeFinished$}autoMovementSet(){return this.autoMovementSet$}depthChanged(){return this.depthChanged$}getMovementProgress(){return this.movementProgress}hasWalkedHalfATile(){return this.movementProgress>500}updateCharacterPosition(t){let e=Math.floor(t/1e3*this.speed*1e3),i=1e3-this.movementProgress<=e&&this.movementProgress<1e3,r=1-(i?1e3-this.movementProgress:e)/e;this.movementProgress=Math.min(this.movementProgress+e,1e3),i&&(this.movementProgress=0,this.shouldContinueMoving()&&r>0?(this.fire(this.positionChangeFinished$,this.tilePos,this.getNextTilePos()),this.tilePos=this.getNextTilePos(),this.startMoving(this.lastMovementImpulse),this.updateCharacterPosition(t*r)):this.stopMoving())}get tilePos(){return P.clone(this._tilePos)}set tilePos(t){P.copyOver(t,this._tilePos)}startMoving(t){"none"!==t&&(t!=this.movementDirection&&this.movementStarted$.next(t),this.movementDirection=t,this.facingDirection=t,this.fire(this.positionChangeStarted$,this.tilePos,this.getNextTilePos()))}tilePosInDirection(t,e){return t.add(b(this.tilemap.toMapDirection(e)))}shouldContinueMoving(){return"none"!==this.lastMovementImpulse&&!this.isBlockingDirection(this.lastMovementImpulse)}stopMoving(){if("none"===this.movementDirection)return;let t=this.tilePos,e=this.getNextTilePos(),i=this.movementDirection;this.tilePos=this.getNextTilePos(),this.movementDirection="none",this.movementStopped$.next(i),this.fire(this.positionChangeFinished$,t,e)}fire(t,{position:e,layer:i},{position:r,layer:n}){t.next({exitTile:e,enterTile:r,exitLayer:i,enterLayer:n})}someCharTile(t){let e=this.getNextTilePos().position;for(let i=e.x;i<e.x+this.getTileWidth();i++)for(let r=e.y;r<e.y+this.getTileHeight();r++)if(t(i,r))return!0;return!1}},tF=class{constructor(t,e){this.walkingAnimationMapping=t,this.charsInRow=e,this.lastFootLeft=!1,this.directionToFrameRow={down:0,"down-left":1,"down-right":2,left:1,right:2,up:3,"up-left":1,"up-right":2},this._isEnabled=!0,this.frameChange$=new td,this.setWalkingAnimationMapping(t)}frameChange(){return this.frameChange$}setIsEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}updateCharacterFrame(t,e,i){this._isEnabled&&(e?this.setStandingFrameDuringWalk(t,i):this.setWalkingFrame(t))}setStandingFrame(t){this._isEnabled&&this._setStandingFrame(t)}setWalkingAnimationMapping(t){this.walkingAnimationMapping=t,this._isEnabled=void 0!==this.walkingAnimationMapping}getWalkingAnimationMapping(){return this.walkingAnimationMapping}getCharsInRow(){return this.charsInRow}setStandingFrameDuringWalk(t,e){this.isCurrentFrameStanding(t,e)||(this.lastFootLeft=!this.lastFootLeft),this._setStandingFrame(t)}setWalkingFrame(t){let e=this.framesOfDirection(t);e&&this.frameChange$.next(this.lastFootLeft?e.rightFoot:e.leftFoot)}_setStandingFrame(t){let e=this.framesOfDirection(t);e&&this.frameChange$.next(e.standing)}isCurrentFrameStanding(t,e){var i;return e===(null==(i=this.framesOfDirection(t))?void 0:i.standing)}framesOfDirection(t){return"number"==typeof this.walkingAnimationMapping?this.getFramesForCharIndex(t,this.walkingAnimationMapping):this.getFramesForAnimationMapping(t)}getFramesForAnimationMapping(t){if(this.walkingAnimationMapping)return this.walkingAnimationMapping[t]||this.walkingAnimationMapping[this.fallbackDirection(t)]}fallbackDirection(t){switch(t){case"down-left":case"up-left":return"left";case"down-right":case"up-right":return"right"}return t}getFramesForCharIndex(t,e){var i;let r=Math.floor(e/this.charsInRow),n=e%this.charsInRow,s=this.charsInRow*tF.FRAMES_CHAR_ROW,o=tF.FRAMES_CHAR_ROW*n+((null!=(i=this.directionToFrameRow[t])?i:0)+r*tF.FRAMES_CHAR_COL)*s;return{rightFoot:o,standing:o+1,leftFoot:o+2}}},tB=tF;tB.FRAMES_CHAR_ROW=3,tB.FRAMES_CHAR_COL=4;var tN=class{static shiftPad(t,e){let i=Math.floor(t),r=`${i}`.padStart(e,"0").length;return i/Math.pow(10,r)}},tG=class{constructor(t,e,i,r,n){this.charData=t,this.scene=e,this.tilemap=i,this.geHeadless=n,this.customOffset=new T(0,0),this.newSpriteSet$=new td,this.destroy$=new td,this.layerOverlaySprite=r&&t.sprite?this.scene.add.sprite(0,0,t.sprite.texture):void 0,this.walkingAnimationMapping=t.walkingAnimationMapping,this.customOffset=new T(t.offsetX||0,t.offsetY||0),this.sprite=t.sprite,this.container=t.container,this.geHeadless.directionChanged().pipe(tA(({charId:t})=>t===this.charData.id)).subscribe(({direction:t})=>{var e;null==(e=this.animation)||e.setStandingFrame(t)}),this.sprite&&(this.sprite.setOrigin(0,0),this.resetAnimation(this.sprite),this.updateOverlaySprite(),this.updateGridChar())}destroy(){this.destroy$.next(),this.destroy$.complete(),this.newSpriteSet$.complete()}setSprite(t){t?(this.sprite&&(t.x=this.sprite.x,t.y=this.sprite.y),this.sprite=t,this.newSpriteSet$.next(),this.layerOverlaySprite=this.layerOverlaySprite?this.scene.add.sprite(0,0,this.sprite.texture):void 0,this.updateOverlaySprite(),this.resetAnimation(this.sprite),this.updateDepth()):(this.layerOverlaySprite=void 0,this.sprite=void 0)}getSprite(){return this.sprite}getLayerOverlaySprite(){return this.layerOverlaySprite}setContainer(t){this.container=t}getContainer(){return this.container}getOffsetX(){return this.customOffset.x}getOffsetY(){return this.customOffset.y}getWalkingAnimationMapping(){return this.walkingAnimationMapping}turnTowards(t){var e;this.geHeadless.isMoving(this.charData.id)||"none"!=t&&(this.geHeadless.turnTowards(this.charData.id,t),null==(e=this.animation)||e.setStandingFrame(t))}getAnimation(){return this.animation}setAnimation(t){this.animation=t}update(t){this.updateGridChar()}getEngineOffset(){var t,e,i,r;if(!this.sprite)return T.ZERO;let n=this.tilemap.getTileWidth()/2-Math.floor((null!=(e=null==(t=this.sprite)?void 0:t.displayWidth)?e:0)/2),s=-(null!=(r=null==(i=this.sprite)?void 0:i.displayHeight)?r:0)+this.tilemap.getTileHeight();return new T(n,s)}updatePixelPos(){let t=new T(this.geHeadless.getPosition(this.charData.id)),e=this.geHeadless.getMovementProgress(this.charData.id)/1e3,i=this.tilemap.tilePosToPixelPos(t).add(this.getEngineOffset()).add(this.customOffset).add(b(this.geHeadless.getFacingDirection(this.charData.id)).multiply(this.tilemap.getTileDistance(this.geHeadless.getFacingDirection(this.charData.id)).scalarMult(e))),r=this.getGameObj();r&&(r.x=i.x,r.y=i.y)}getGameObj(){return this.container||this.sprite}updateGridChar(){var t;if(this.updatePixelPos(),this.sprite&&this.geHeadless.isMoving(this.charData.id)){let e=this.geHeadless.getMovementProgress(this.charData.id)>500;null==(t=this.getAnimation())||t.updateCharacterFrame(this.geHeadless.getFacingDirection(this.charData.id),e,Number(this.sprite.frame.name))}this.updateDepth()}resetAnimation(t){let e=new tB(this.walkingAnimationMapping,t.texture.source[0].width/t.width/tB.FRAMES_CHAR_ROW);this.setAnimation(e),e.frameChange().pipe(tR(this.newSpriteSet$)).subscribe(e=>{null==t||t.setFrame(e)}),e.setIsEnabled(void 0!==this.walkingAnimationMapping),e.setStandingFrame(this.geHeadless.getFacingDirection(this.charData.id))}updateOverlaySprite(){if(!this.layerOverlaySprite||!this.sprite)return;this.layerOverlaySprite.scale=this.sprite.scale;let t=this.tilemap.getTileHeight()/this.layerOverlaySprite.scale;this.layerOverlaySprite.setCrop(0,0,this.layerOverlaySprite.displayWidth,this.sprite.height-t),this.layerOverlaySprite.setOrigin(0,0)}updateDepth(){let t=this.getGameObj();if(!t)return;let e=new T(this.geHeadless.getPosition(this.charData.id)),i=this.geHeadless.getCharLayer(this.charData.id);this.setDepth(t,{position:e,layer:i});let r=this.getLayerOverlaySprite();if(r){let t=new T(v(y({},e),{y:e.y-1}));this.setDepth(r,{position:t,layer:i})}}setDepth(t,e){t.setDepth(this.tilemap.getDepthOfCharLayer(this.getTransitionLayer(e))+this.getPaddedPixelDepth(t))}getPaddedPixelDepth(t){return tN.shiftPad(t.y+t.displayHeight,7)}getTransitionLayer(t){if(t.layer)return this.geHeadless.getTransition(t.position,t.layer)||t.layer}},tW=((s=tW||{}).DONT_BLOCK="DONT_BLOCK",s.BLOCK_TWO_TILES="BLOCK_TWO_TILES",s.BLOCK_ONE_TILE_AHEAD="BLOCK_ONE_TILE_AHEAD",s.BLOCK_ONE_TILE_BEHIND="BLOCK_ONE_TILE_BEHIND",s),t$=((o=t$||{}).STOP="STOP",o.CLOSEST_REACHABLE="CLOSEST_REACHABLE",o.RETRY="RETRY",o),tU=class{static vec2str(t){return`${t.x}#${t.y}`}static equal(t,e){return tU.vec2str(t)==tU.vec2str(e)}static manhattanDistance(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}static chebyshevDistance(t,e){return Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))}static scalarMult(t,e){return t.clone().multiply(new T(e,e))}},tz=class{distance(t,e){return tU.manhattanDistance(t,e)}direction(t,e){if(tU.equal(t,e))return"none";let i=t.clone().subtract(e);return Math.abs(i.x)>Math.abs(i.y)?i.x>0?"left":"right":i.y>0?"up":"down"}neighbors(t){return[new T(t.x,t.y+1),new T(t.x+1,t.y),new T(t.x-1,t.y),new T(t.x,t.y-1)]}getDirections(){return["up","right","down","left"]}},tq=class{distance(t,e){return tU.chebyshevDistance(t,e)}neighbors(t){return[new T(t.x,t.y+1),new T(t.x+1,t.y),new T(t.x-1,t.y),new T(t.x,t.y-1),new T(t.x+1,t.y+1),new T(t.x+1,t.y-1),new T(t.x-1,t.y+1),new T(t.x-1,t.y-1)]}direction(t,e){return e.x>t.x?e.y>t.y?"down-right":e.y<t.y?"up-right":"right":e.x<t.x?e.y>t.y?"down-left":e.y<t.y?"up-left":"left":e.y<t.y?"up":e.y>t.y?"down":"none"}getDirections(){return["up","right","down","left","down-left","down-right","up-right","up-left"]}},tX=class{static create(t){switch(t){case 4:return new tz;case 8:return new tq}}},tY=class{constructor(t,e,i){this.backoffMs=t,this.maxRetries=e,this.onFinished=i,this.retries=0,this.elapsed=0}retry(t,e){this.shouldRetry()?(this.elapsed+=t,this.elapsed>=this.backoffMs&&(this.elapsed=0,this.retries++,e())):this.onFinished()}reset(){this.retries=0,this.elapsed=0}getMaxRetries(){return this.maxRetries}getBackoffMs(){return this.backoffMs}shouldRetry(){return -1===this.maxRetries||this.retries<this.maxRetries}},tj=((a=tj||{}).WAIT="WAIT",a.RETRY="RETRY",a.STOP="STOP",a),tK=class{constructor(t){this.data=t}},tV=class{constructor(){this.sizeInternal=0}dequeue(){if(void 0===this.tail)return;this.sizeInternal--;let t=this.tail.data;return void 0===this.tail.prev?(this.tail=void 0,this.head=void 0,t):(this.tail.prev.next=void 0,this.tail=this.tail.prev,t)}enqueue(t){if(this.sizeInternal++,void 0===this.head){this.head=new tK(t),this.tail=this.head;return}let e=new tK(t);e.next=this.head,this.head.prev=e,this.head=e}peek(){return this.tail?this.tail.data:void 0}size(){return this.sizeInternal}},tZ=class{constructor(){this.maxPathLength=1/0}setMaxPathLength(t){this.maxPathLength=t}getShortestPath(t,e,i,r){let n=this.shortestPathBfs(t,e,i,r);return{path:this.returnPath(n.previous,t,e),closestToTarget:n.closestToTarget,steps:n.steps,maxPathLengthReached:n.maxPathLengthReached}}pos2Str(t){return`${t.position.toString()}#${t.layer}`}equal(t,e){return!!tU.equal(t.position,e.position)&&t.layer===e.layer}shortestPathBfs(t,e,i,r){let n=new Map,s=new Set,o=new tV,a=t,h=r(t.position,e.position),l=0;for(o.enqueue({node:t,dist:0}),s.add(this.pos2Str(t));o.size()>0;){let t=o.dequeue();if(l++,!t)break;let{node:c,dist:u}=t;if(u>this.maxPathLength)return{previous:new Map,closestToTarget:a,steps:l,maxPathLengthReached:!0};let d=r(c.position,e.position);if(d<h&&(h=d,a=c),this.equal(c,e))break;for(let t of i(c))s.has(this.pos2Str(t))||(n.set(this.pos2Str(t),c),o.enqueue({node:t,dist:u+1}),s.add(this.pos2Str(t)))}return{previous:n,closestToTarget:a,steps:l,maxPathLengthReached:!1}}returnPath(t,e,i){let r=[],n=i;for(r.push(n);!this.equal(n,e);){if(!(n=t.get(this.pos2Str(n))))return[];r.push(n)}return r.reverse()}},tJ=class{constructor(){this.previous=new Map,this.visited=new Map,this.queue=new tV}step(t,e,i){for(let r of t)this.visited.has(P.toString(r))||(this.previous.set(P.toString(r),e),this.queue.enqueue({node:r,dist:i+1}),this.visited.set(P.toString(r),i+1))}},tQ=class{constructor(){this.maxPathLength=1/0}setMaxPathLength(t){this.maxPathLength=t}getShortestPath(t,e,i,r,n){let s=this.shortestPathBfs(t,e,i,r,n);return{path:this.returnPath(s.previous,s.previous2,s.matchingPos,t,e),closestToTarget:s.closestToTarget,steps:s.steps,maxPathLengthReached:s.maxPathLengthReached}}equal(t,e){return!!tU.equal(t.position,e.position)&&t.layer===e.layer}shortestPathBfs(t,e,i,r,n){var s;let o=new tJ,a=new tJ,h=0;o.otherBfs=a,a.otherBfs=o;let l=t,c=r(t.position,e.position);for(o.queue.enqueue({node:t,dist:0}),a.queue.enqueue({node:e,dist:0}),o.visited.set(P.toString(t),0),a.visited.set(P.toString(e),0);o.queue.size()>0||a.queue.size()>0;){let t=o.queue.dequeue();if(!t)break;let{node:u,dist:d}=t;if(d+1+((null==(s=a.queue.peek())?void 0:s.dist)||0)>this.maxPathLength)return{previous:o.previous,previous2:a.previous,closestToTarget:l,steps:h,maxPathLengthReached:!0};let p=r(u.position,e.position);if(p<c&&(c=p,l=u),a.visited.has(P.toString(u)))return{previous:o.previous,previous2:a.previous,closestToTarget:e,matchingPos:u,steps:h,maxPathLengthReached:!1};h++,o.step(i(u),u,d);let g=a.queue.dequeue();if(!g)continue;let{node:f,dist:m}=g;if(o.visited.has(P.toString(f)))return{previous:o.previous,previous2:a.previous,closestToTarget:e,matchingPos:f,steps:h,maxPathLengthReached:!1};h++,a.step(n(f),f,m)}return{previous:o.previous,previous2:a.previous,closestToTarget:l,steps:h,maxPathLengthReached:!1}}returnPath(t,e,i,r,n){if(!i)return this.getPathFromPrev(t,r,n).reverse();{let s=this.getPathFromPrev(t,r,i).reverse(),o=this.getPathFromPrev(e,n,i);return s.pop(),[...s,...o]}}getPathFromPrev(t,e,i){let r=[],n=i;for(r.push(n);!this.equal(n,e);){if(!(n=t.get(P.toString(n))))return[];r.push(n)}return r}},t0=class{constructor(t,e){this.shortestPathAlgorithm=t,this.gridTilemap=e}findShortestPath(t,e,{shortestPathAlgorithm:i,pathWidth:r=1,pathHeight:n=1,numberOfDirections:s=4,isPositionAllowed:o=(t,e)=>!0,collisionGroups:a=[],ignoredChars:h=[],ignoreTiles:l=!1,ignoreMapBounds:c=!1,ignoreBlockedTarget:u=!1,maxPathLength:d=1/0}={}){var p,g,f,m;let y,v,T="BIDIRECTIONAL_SEARCH"===(null!=i?i:this.shortestPathAlgorithm)?new tQ:new tZ;T.setMaxPathLength(d);let w={shortestPathAlgorithm:i||this.shortestPathAlgorithm,pathWidth:r,pathHeight:n,numberOfDirections:s,isPositionAllowed:o,collisionGroups:a,ignoredChars:h,ignoreTiles:l,ignoreMapBounds:c,ignoreBlockedTarget:u,maxPathLength:d},C=(p=this.gridTilemap,y=tX.create(null!=(g=w.numberOfDirections)?g:4),t=>y.neighbors(t.position).map(e=>{let i=p.getTransition(e,t.layer);return{position:e,layer:i||t.layer}}).filter(i=>!t1(t,i,p,w)||w.ignoreBlockedTarget&&P.equal(i,e))),b=(f=this.gridTilemap,v=tX.create(null!=(m=w.numberOfDirections)?m:4),t=>{let i=v.neighbors(t.position),r=f.getTransitions(),n=[...r.keys()].filter(e=>e===t.position.toString()).map(t=>r.get(t)).map(e=>e?[...e.keys()].filter(i=>e.get(i)===t.layer):[]).flat(),s=f.getTransition(t.position,t.layer);return s&&s!==t.layer||n.push(t.layer),i.map(e=>n.map(i=>({position:e,layer:i||t.layer}))).flat().filter(i=>!t1(i,t,f,w)||w.ignoreBlockedTarget&&P.equal(t,e))}),S=4===s?tU.manhattanDistance:tU.chebyshevDistance;return T.getShortestPath(t,e,C,S,b)}};function t1(t,e,i,r){let n=r.isPositionAllowed(e.position,e.layer),s=!r.ignoreTiles&&function(t,e,i,r,n,s){for(let o=e.position.x;o<e.position.x+i;o++)for(let i=e.position.y;i<e.position.y+r;i++)if(s.hasBlockingTile(new T(o,i),e.layer,S(function(t,e){if(t.x===e.x){if(t.y>e.y)return"up";if(t.y<e.y)return"down"}else if(t.y===e.y){if(t.x>e.x)return"left";if(t.x<e.x)return"right"}else if(t.x>e.x){if(t.y<e.y)return"down-left";if(t.y>e.y)return"up-left"}else if(t.x<e.x){if(t.y<e.y)return"down-right";if(t.y>e.y)return"up-right"}return"none"}(t.position,e.position)),n))return!0;return!1}(t,e,r.pathWidth,r.pathHeight,r.ignoreMapBounds,i),o=r.ignoreMapBounds||i.isInRange(e.position);return function(t,e,i,r,n,s){for(let o=t.position.x;o<t.position.x+e;o++)for(let e=t.position.y;e<t.position.y+i;e++)if(s.hasBlockingChar(new T(o,e),t.layer,r,new Set(n)))return!0;return!1}(e,r.pathWidth,r.pathHeight,r.collisionGroups,r.ignoredChars,i)||s||!o||!n}var t2=((h=t2||{}).SUCCESS="SUCCESS",h.NO_PATH_FOUND_MAX_RETRIES_EXCEEDED="NO_PATH_FOUND_MAX_RETRIES_EXCEEDED",h.PATH_BLOCKED_MAX_RETRIES_EXCEEDED="PATH_BLOCKED_MAX_RETRIES_EXCEEDED",h.PATH_BLOCKED="PATH_BLOCKED",h.NO_PATH_FOUND="NO_PATH_FOUND",h.PATH_BLOCKED_WAIT_TIMEOUT="PATH_BLOCKED_WAIT_TIMEOUT",h.MOVEMENT_TERMINATED="MOVEMENT_TERMINATED",h.MAX_PATH_LENGTH_REACHED="MAX_PATH_LENGTH_REACHED",h),t3=class{constructor(t,e,i,{config:r,ignoreBlockedTarget:n=!1,distance:s=0}={}){var o;this.character=t,this.tilemap=e,this.targetPos=i,this.shortestPath=[],this.distOffset=0,this.posOnPath=0,this.stopped=!1,this.pathBlockedWaitElapsed=0,this.isPositionAllowed=()=>!0,this.shortestPathAlgorithm="BIDIRECTIONAL_SEARCH",this.maxPathLength=1/0,this.isBlocking=(t,e)=>!t||t1(this.character.getTilePos(),{position:t,layer:e},this.tilemap,this.getPathfindingOptions()),this.shortestPathAlgorithm=null!=(o=null==r?void 0:r.algorithm)?o:this.shortestPathAlgorithm,this.ignoreBlockedTarget=n,this.distance=s,this.noPathFoundStrategy=(null==r?void 0:r.noPathFoundStrategy)||"STOP",this.pathBlockedStrategy=(null==r?void 0:r.pathBlockedStrategy)||"WAIT",this.noPathFoundRetryable=new tY((null==r?void 0:r.noPathFoundRetryBackoffMs)||200,(null==r?void 0:r.noPathFoundMaxRetries)||-1,()=>{this.stop("NO_PATH_FOUND_MAX_RETRIES_EXCEEDED")}),this.pathBlockedRetryable=new tY((null==r?void 0:r.pathBlockedRetryBackoffMs)||200,(null==r?void 0:r.pathBlockedMaxRetries)||-1,()=>{this.stop("PATH_BLOCKED_MAX_RETRIES_EXCEEDED")}),null!=r&&r.isPositionAllowedFn&&(this.isPositionAllowed=r.isPositionAllowedFn),null!=r&&r.maxPathLength&&(this.maxPathLength=r.maxPathLength),this.distanceUtils=tX.create(t.getNumberOfDirections()),this.pathBlockedWaitTimeoutMs=(null==r?void 0:r.pathBlockedWaitTimeoutMs)||-1,this.finished$=new td,this.setCharacter(t)}setPathBlockedStrategy(t){this.pathBlockedStrategy=t}getPathBlockedStrategy(){return this.pathBlockedStrategy}setCharacter(t){this.character=t,this.noPathFoundRetryable.reset(),this.pathBlockedRetryable.reset(),this.pathBlockedWaitElapsed=0,this.calcShortestPath(),this.character.autoMovementSet().pipe(tA(t=>t!==this),tk(1)).subscribe(()=>{this.stop("MOVEMENT_TERMINATED")})}getPathfindingOptions(){return{shortestPathAlgorithm:this.shortestPathAlgorithm,pathWidth:this.character.getTileWidth(),pathHeight:this.character.getTileHeight(),numberOfDirections:this.character.getNumberOfDirections(),isPositionAllowed:this.isPositionAllowed,collisionGroups:this.character.getCollisionGroups(),ignoredChars:[this.character.getId()],ignoreTiles:!this.character.collidesWithTiles(),ignoreMapBounds:this.character.getIgnoreMissingTiles(),ignoreBlockedTarget:this.ignoreBlockedTarget,maxPathLength:this.maxPathLength}}update(t){var e,i,r,n;this.stopped||(this.noPathFound()&&("RETRY"===this.noPathFoundStrategy?this.noPathFoundRetryable.retry(t,()=>this.calcShortestPath()):"STOP"===this.noPathFoundStrategy&&this.stop("NO_PATH_FOUND")),this.updatePosOnPath(),this.isBlocking(null==(e=this.nextTileOnPath())?void 0:e.position,null==(i=this.character)?void 0:i.getNextTilePos().layer)?this.applyPathBlockedStrategy(t):this.pathBlockedWaitElapsed=0,this.hasArrived()?(this.stop("SUCCESS"),this.existsDistToTarget()&&this.turnTowardsTarget()):this.isBlocking(null==(r=this.nextTileOnPath())?void 0:r.position,null==(n=this.character)?void 0:n.getNextTilePos().layer)||this.moveCharOnPath())}finishedObs(){return this.finished$}getInfo(){return{type:"Target",config:{algorithm:this.shortestPathAlgorithm,ignoreBlockedTarget:this.ignoreBlockedTarget,distance:this.distance,targetPos:this.targetPos,noPathFoundStrategy:this.noPathFoundStrategy,pathBlockedStrategy:this.pathBlockedStrategy,noPathFoundRetryBackoffMs:this.noPathFoundRetryable.getBackoffMs(),noPathFoundMaxRetries:this.noPathFoundRetryable.getMaxRetries()}}}resultToReason(t){switch(t){case"SUCCESS":return"Successfully arrived.";case"MOVEMENT_TERMINATED":return"Movement of character has been replaced before destination was reached.";case"PATH_BLOCKED":return"PathBlockedStrategy STOP: Path blocked.";case"NO_PATH_FOUND_MAX_RETRIES_EXCEEDED":return`NoPathFoundStrategy RETRY: Maximum retries of ${this.noPathFoundRetryable.getMaxRetries()} exceeded.`;case"NO_PATH_FOUND":return"NoPathFoundStrategy STOP: No path found.";case"PATH_BLOCKED_MAX_RETRIES_EXCEEDED":return`PathBlockedStrategy RETRY: Maximum retries of ${this.pathBlockedRetryable.getMaxRetries()} exceeded.`;case"PATH_BLOCKED_WAIT_TIMEOUT":return`PathBlockedStrategy WAIT: Wait timeout of ${this.pathBlockedWaitTimeoutMs}ms exceeded.`}}applyPathBlockedStrategy(t){"RETRY"===this.pathBlockedStrategy?this.pathBlockedRetryable.retry(t,()=>{let t=this.getShortestPath();t.path.length>0&&this.calcShortestPath(t)}):"STOP"===this.pathBlockedStrategy?this.stop("PATH_BLOCKED"):"WAIT"===this.pathBlockedStrategy&&this.pathBlockedWaitTimeoutMs>-1&&(this.pathBlockedWaitElapsed+=t,this.pathBlockedWaitElapsed>=this.pathBlockedWaitTimeoutMs&&this.stop("PATH_BLOCKED_WAIT_TIMEOUT"))}moveCharOnPath(){let t=this.nextTileOnPath();if(!t)return;let e=this.getDir(this.character.getNextTilePos().position,t.position);this.character.move(e)}nextTileOnPath(){return this.shortestPath[this.posOnPath+1]}stop(t){this.finished$.next({position:this.character.getTilePos().position,result:t,description:this.resultToReason(t),layer:this.character.getTilePos().layer}),this.finished$.complete(),this.stopped=!0}turnTowardsTarget(){let t=this.shortestPath[this.posOnPath+1],e=this.getDir(this.character.getNextTilePos().position,t.position);this.character.turnTowards(e)}existsDistToTarget(){return this.posOnPath<this.shortestPath.length-1}hasArrived(){return!this.noPathFound()&&this.posOnPath+Math.max(0,this.distance-this.distOffset)>=this.shortestPath.length-1}updatePosOnPath(){let t=this.shortestPath[this.posOnPath];for(;this.posOnPath<this.shortestPath.length-1&&(this.character.getNextTilePos().position.x!=t.position.x||this.character.getNextTilePos().position.y!=t.position.y);)this.posOnPath++,t=this.shortestPath[this.posOnPath]}noPathFound(){return 0===this.shortestPath.length}calcShortestPath(t){t=null!=t?t:this.getShortestPath(),this.posOnPath=0,this.shortestPath=t.path,this.distOffset=t.distOffset}getShortestPath(){let t=new t0(this.shortestPathAlgorithm,this.tilemap),{path:e,closestToTarget:i}=t.findShortestPath(this.character.getNextTilePos(),this.targetPos,this.getPathfindingOptions());return 0==e.length&&"CLOSEST_REACHABLE"===this.noPathFoundStrategy?{path:t.findShortestPath(this.character.getNextTilePos(),i,this.getPathfindingOptions()).path,distOffset:this.distanceUtils.distance(i.position,this.targetPos.position)}:{path:e,distOffset:0}}getDir(t,e){return this.tilemap.fromMapDirection(this.distanceUtils.direction(t,e))}},t4="2.27.0",t5=class{constructor(t,e,i,r=0,n="STOP",s=1/0){this.character=t,this.gridTilemap=e,this.charToFollow=i,this.distance=r,this.noPathFoundStrategy=n,this.maxPathLength=s,this.character=t,this.updateTarget(this.charToFollow.getTilePos().position,this.charToFollow.getTilePos().layer),this.charToFollow.positionChangeStarted().pipe(tR(this.character.autoMovementSet().pipe(tA(t=>t!==this),tk(1)))).subscribe(({enterTile:t,enterLayer:e})=>{this.updateTarget(t,e)})}update(t){var e;null==(e=this.targetMovement)||e.update(t)}getInfo(){return{type:"Follow",config:{charToFollow:this.charToFollow.getId(),distance:this.distance,noPathFoundStrategy:this.noPathFoundStrategy,maxPathLength:this.maxPathLength}}}updateTarget(t,e){this.targetMovement=new t3(this.character,this.gridTilemap,{position:new T(t),layer:e},{distance:this.distance+1,config:{noPathFoundStrategy:this.noPathFoundStrategy,maxPathLength:this.maxPathLength},ignoreBlockedTarget:!0})}},t7=class{static getRandomInt(t){return Math.floor(Math.random()*Math.floor(t))}},t9=class{constructor(t,e=0,i=-1){this.character=t,this.delay=e,this.radius=i,this.stepSize=0,this.delayLeft=this.delay,this.initialRow=t.getNextTilePos().position.y,this.initialCol=t.getNextTilePos().position.x,this.randomizeStepSize(),this.stepsWalked=0,this.currentMovementDirection="none",this.character.positionChangeStarted().pipe(tR(this.character.autoMovementSet().pipe(tA(t=>t!==this),tk(1)))).subscribe(()=>{this.stepsWalked++}),this.distanceUtils=tX.create(t.getNumberOfDirections())}update(t){if(this.shouldContinueWalkingCurrentDirection())this.character.move(this.currentMovementDirection);else if(this.delayLeft-=t,this.delayLeft<=0){this.delayLeft=this.delay;let t=this.getFreeRandomDirection();this.stepsWalked=0,this.character.move(t),this.currentMovementDirection=t,this.randomizeStepSize()}}getInfo(){return{type:"Random",config:{delay:this.delay,radius:this.radius}}}shouldContinueWalkingCurrentDirection(){return this.stepsWalked<this.stepSize&&"none"!==this.currentMovementDirection&&!this.character.isBlockingDirection(this.currentMovementDirection)&&this.isWithinRadius(this.currentMovementDirection)}getFreeDirections(){return this.distanceUtils.getDirections().filter(t=>!this.character.isBlockingDirection(t)).filter(t=>this.isWithinRadius(t))}isWithinRadius(t){return -1==this.radius||this.getDist(t)<=this.radius}getDist(t){return this.distanceUtils.distance(this.character.getNextTilePos().position.add(b(t)),new T(this.initialCol,this.initialRow))}getFreeRandomDirection(){let t=this.getFreeDirections();return 0==t.length?"none":t[t7.getRandomInt(t.length)]}randomizeStepSize(){this.stepSize=t7.getRandomInt(this.radius)+1}},t6=class{constructor(t){this.collistionStrategy=t,this.tilePosToCharacters=new Map,this.charRemoved$=new td}isCharBlockingAt(t,e,i,r=new Set){let n=this.posToString(t,e),s=this.tilePosToCharacters.get(n);return!!(s&&s.size>0&&[...s].filter(t=>!r.has(t.getId())).some(t=>t.getCollisionGroups().some(t=>i.includes(t))))}getCharactersAt(t,e){let i=this.posToString(t,e),r=this.tilePosToCharacters.get(i);return new Set(r)}addCharacter(t){this.addTilePositions(t.getTilePos(),t),this.addTilePositions(t.getNextTilePos(),t),this.addPositionChangeSub(t),this.addPositionChangeFinishedSub(t),this.addTilePosSetSub(t)}removeCharacter(t){let e=t.getId();this.charRemoved$.next(e),this.deleteTilePositions(t.getTilePos(),t),this.deleteTilePositions(t.getNextTilePos(),t)}add(t,e){var i;this.tilePosToCharacters.has(t)||this.tilePosToCharacters.set(t,new Set),null==(i=this.tilePosToCharacters.get(t))||i.add(e)}addTilePosSetSub(t){t.tilePositionSet().pipe(tR(this.charRemoved(t.getId()))).subscribe(e=>{this.deleteTilePositions(t.getNextTilePos(),t),this.addTilePositions(e,t)})}charRemoved(t){var e;return null==(e=this.charRemoved$)?void 0:e.pipe(tk(1),tA(e=>e==t))}addPositionChangeSub(t){t.positionChangeStarted().pipe(tR(this.charRemoved(t.getId())),this.posChangeToLayerPos()).subscribe(e=>{"BLOCK_ONE_TILE_AHEAD"===this.collistionStrategy&&this.deleteTilePositions(e.exit,t),this.addTilePositions(e.enter,t)})}addPositionChangeFinishedSub(t){t.positionChangeFinished().pipe(tR(this.charRemoved(t.getId())),this.posChangeToLayerPos()).subscribe(e=>{this.deleteTilePositions(e.exit,t),this.addTilePositions(e.enter,t)})}addTilePositions(t,e){this.forEachCharTile(t,e,(i,r)=>{this.add(this.posToString(new T(i,r),t.layer),e)})}deleteTilePositions(t,e){this.forEachCharTile(t,e,(i,r)=>{var n;null==(n=this.tilePosToCharacters.get(this.posToString(new T(i,r),t.layer)))||n.delete(e)})}forEachCharTile(t,e,i){let r=t.position;for(let t=r.x;t<r.x+e.getTileWidth();t++)for(let n=r.y;n<r.y+e.getTileHeight();n++)i(t,n)}posChangeToLayerPos(){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return ts(t)}(tL(t=>({enter:{position:new T(t.enterTile),layer:t.enterLayer},exit:{position:new T(t.exitTile),layer:t.exitLayer}})))}posToString(t,e){return`${t.x}#${t.y}#${e}`}},t8=class{constructor(t,e,i,r){this.x=t,this.y=e,this.width=i,this.height=r}getX(){return this.x}getY(){return this.y}getWidth(){return this.width}getHeight(){return this.height}isInRange(t){return t.x>=this.x&&t.x<this.x+this.width&&t.y>=this.y&&t.y<this.y+this.height}},et="ge_charLayer",ee=class{constructor(t,e,i){this.tilemap=t,this.collisionTilePropertyName=e,this.characters=new Map,this.transitions=new Map,this.charBlockCache=new t6(i)}addCharacter(t){this.characters.set(t.getId(),t),void 0===t.getNextTilePos().layer&&t.setTilePosition(v(y({},t.getNextTilePos()),{layer:this.getLowestCharLayer()})),this.charBlockCache.addCharacter(t)}removeCharacter(t){let e=this.characters.get(t);e&&(this.charBlockCache.removeCharacter(e),this.characters.delete(t))}getCharacters(){return[...this.characters.values()]}getCharactersAt(t,e){return this.charBlockCache.getCharactersAt(t,e)}hasBlockingTile(t,e,i,r){return!!(!r&&this.hasNoTile(t,e))||this.getCollisionRelevantLayers(e).some(e=>this.isLayerBlockingAt(e.getName(),t,i))}getTransition(t,e){let i=this.transitions.get(t.toString());if(i)return i.get(e)}setTransition(t,e,i){var r;this.transitions.has(t.toString())||this.transitions.set(t.toString(),new Map),null==(r=this.transitions.get(t.toString()))||r.set(e,i)}getTransitions(){return new Map([...this.transitions].map(([t,e])=>[t,new Map(e)]))}hasNoTile(t,e){return!this.getCollisionRelevantLayers(e).some(e=>this.tilemap.hasTileAt(t.x,t.y,e.getName()))}hasBlockingChar(t,e,i,r=new Set){return this.charBlockCache.isCharBlockingAt(t,e,i,r)}isInRange(t){return new t8(0,0,this.tilemap.getWidth(),this.tilemap.getHeight()).isInRange(t)}toMapDirection(t){return this.isIsometric()?({left:"down-left","up-left":"left",up:"up-left","up-right":"up",right:"up-right","down-right":"right",down:"down-right","down-left":"down",none:"none"})[t]:t}fromMapDirection(t){return this.isIsometric()?({left:"up-left","up-left":"up",up:"up-right","up-right":"right",right:"down-right","down-right":"down",down:"down-left","down-left":"left",none:"none"})[t]:t}isIsometric(){return"isometric"===this.tilemap.getOrientation()}getTilePosInDirection(t,e){let i=t.position.add(b(this.toMapDirection(e))),r=this.getTransition(i,t.layer)||t.layer;return{position:i,layer:r}}isLayerBlockingAt(t,e,i){let r=ee.ONE_WAY_COLLIDE_PROP_PREFIX+i,n=this.tilemap.getTileAt(e.x,e.y,t);return!!(null!=n&&n.getProperty(this.collisionTilePropertyName)||null!=n&&n.getProperty(r))}getCharLayerIndexes(){return this.tilemap.getLayers().map((t,e)=>({layer:t,index:e})).filter(({layer:t})=>t.isCharLayer()).map(({index:t})=>t)}findPrevAndCharLayer(t){let e=this.getCharLayerIndexes(),i=this.tilemap.getLayers(),r=e.findIndex(e=>i[e].getProperty(et)==t);return 0==r?{prevIndex:-1,charLayerIndex:e[r]}:{prevIndex:e[r-1],charLayerIndex:e[r]}}getCollisionRelevantLayers(t){if(!t)return this.tilemap.getLayers();let{prevIndex:e,charLayerIndex:i}=this.findPrevAndCharLayer(t);return this.tilemap.getLayers().slice(e+1,i+1)}getLowestCharLayer(){for(let t of this.tilemap.getLayers())if(t.isCharLayer())return t.getName()}},ei=ee;ei.ONE_WAY_COLLIDE_PROP_PREFIX="ge_collide_";var er=((l=er||{}).REMOVED="REMOVED",l.ADDED="ADDED",l),en=class{constructor(){this.isCreatedInternal=!1,console.log(`Using GridEngine v${t4}`)}getCharLayer(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getTilePos().layer}getTransition(t,e){var i;return this.initGuard(),null==(i=this.gridTilemap)?void 0:i.getTransition(new T(t),e)}setTransition(t,e,i){var r;return this.initGuard(),null==(r=this.gridTilemap)?void 0:r.setTransition(new T(t),e,i)}create(t,e){this.isCreatedInternal=!0,this.gridCharacters=new Map;let i=this.setConfigDefaults(e);this.config=i,this.movementStopped$=new td,this.movementStarted$=new td,this.directionChanged$=new td,this.positionChangeStarted$=new td,this.positionChangeFinished$=new td,this.charRemoved$=new td,this.charAdded$=new td,this.gridTilemap=new ei(t,this.config.collisionTilePropertyName,this.config.characterCollisionStrategy),this.addCharacters()}getPosition(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getTilePos().position}move(t,e){this.moveChar(t,e)}moveRandomly(t,e=0,i=-1){var r;this.initGuard();let n=null==(r=this.gridCharacters)?void 0:r.get(t);if(!n)throw this.createCharUnknownErr(t);let s=new t9(n,e,i);n.setMovement(s)}getMovement(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);let r=i.getMovement();return r?r.getInfo():{type:"None"}}moveTo(t,e,i){var r;let n=this.assembleMoveToConfig(i);this.initGuard();let s=null==(r=this.gridCharacters)?void 0:r.get(t);if(!s)throw this.createCharUnknownErr(t);if(!this.gridTilemap)throw this.createUninitializedErr();let o=new t3(s,this.gridTilemap,{position:new T(e),layer:(null==i?void 0:i.targetLayer)||s.getNextTilePos().layer},{distance:0,config:n});return s.setMovement(o),o.finishedObs().pipe(tL(e=>({charId:t,position:e.position,result:e.result,description:e.description,layer:e.layer})))}stopMovement(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);i.setMovement(void 0)}setSpeed(t,e){var i;this.initGuard();let r=null==(i=this.gridCharacters)?void 0:i.get(t);if(!r)throw this.createCharUnknownErr(t);r.setSpeed(e)}getSpeed(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getSpeed()}collidesWithTiles(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.collidesWithTiles()}update(t,e){if(this.isCreatedInternal&&this.gridCharacters)for(let[t,i]of this.gridCharacters)i.update(e)}addCharacter(t){var e,i,r,n,s;if(!this.gridTilemap||!this.config)throw this.createUninitializedErr();let o={speed:t.speed||4,tilemap:this.gridTilemap,collidesWithTiles:!0,collisionGroups:["geDefault"],charLayer:t.charLayer,facingDirection:t.facingDirection,labels:t.labels,numberOfDirections:null!=(e=t.numberOfDirections)?e:this.config.numberOfDirections,tileWidth:t.tileWidth,tileHeight:t.tileHeight};"boolean"==typeof t.collides?!1===t.collides&&(o.collidesWithTiles=!1,o.collisionGroups=[]):void 0!==t.collides&&(!1===t.collides.collidesWithTiles&&(o.collidesWithTiles=!1),t.collides.collisionGroups&&(o.collisionGroups=t.collides.collisionGroups),o.ignoreMissingTiles=null!=(r=null==(i=t.collides)?void 0:i.ignoreMissingTiles)&&r);let a=new tH(t.id,o);t.startPosition&&a.setTilePosition({position:new T(t.startPosition),layer:a.getTilePos().layer}),null==(n=this.gridCharacters)||n.set(t.id,a),this.gridTilemap.addCharacter(a);let h=a.getId();a.movementStopped().pipe(tR(this.charRemoved(h))).subscribe(t=>{var e;null==(e=this.movementStopped$)||e.next({charId:h,direction:t})}),a.movementStarted().pipe(tR(this.charRemoved(h))).subscribe(t=>{var e;null==(e=this.movementStarted$)||e.next({charId:h,direction:t})}),a.directionChanged().pipe(tR(this.charRemoved(h))).subscribe(t=>{var e;null==(e=this.directionChanged$)||e.next({charId:h,direction:t})}),a.positionChangeStarted().pipe(tR(this.charRemoved(h))).subscribe(t=>{var e;null==(e=this.positionChangeStarted$)||e.next(y({charId:h},t))}),a.positionChangeFinished().pipe(tR(this.charRemoved(h))).subscribe(t=>{var e;null==(e=this.positionChangeFinished$)||e.next(y({charId:h},t))}),null==(s=this.charAdded$)||s.next(h)}hasCharacter(t){var e;return this.initGuard(),!!(null!=(e=this.gridCharacters)&&e.has(t))}removeCharacter(t){var e,i,r,n;if(this.initGuard(),!(null==(e=this.gridCharacters)?void 0:e.get(t)))throw this.createCharUnknownErr(t);null==(i=this.gridTilemap)||i.removeCharacter(t),null==(r=this.gridCharacters)||r.delete(t),null==(n=this.charRemoved$)||n.next(t)}removeAllCharacters(){if(this.initGuard(),this.gridCharacters)for(let t of this.gridCharacters.keys())this.removeCharacter(t)}getAllCharacters(t){if(this.initGuard(),!this.gridCharacters)return[];let e=[...this.gridCharacters.values()];return(t?e.filter(e=>{var i,r,n,s,o,a;return null!=(i=t.labels)&&i.withAllLabels?null==(r=t.labels)?void 0:r.withAllLabels.every(t=>e.hasLabel(t)):null!=(n=t.labels)&&n.withOneOfLabels?null==(s=t.labels)?void 0:s.withOneOfLabels.some(t=>e.hasLabel(t)):null==(o=t.labels)||!o.withNoneLabels||!(null!=(a=t.labels)&&a.withNoneLabels.some(t=>e.hasLabel(t)))}):e).map(t=>t.getId())}getLabels(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getLabels()}addLabels(t,e){var i;this.initGuard();let r=null==(i=this.gridCharacters)?void 0:i.get(t);if(!r)throw this.createCharUnknownErr(t);r.addLabels(e)}removeLabels(t,e){var i;this.initGuard();let r=null==(i=this.gridCharacters)?void 0:i.get(t);if(!r)throw this.createCharUnknownErr(t);r.removeLabels(e)}clearLabels(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);i.clearLabels()}follow(t,e,i,r){var n,s;let o;void 0===i?o={distance:0,closestPointIfBlocked:!1}:"number"==typeof i?(o={distance:i,closestPointIfBlocked:!1},r&&(o.closestPointIfBlocked=!0)):o=i,this.initGuard();let a=null==(n=this.gridCharacters)?void 0:n.get(t),h=null==(s=this.gridCharacters)?void 0:s.get(e);if(!a)throw this.createCharUnknownErr(t);if(!h)throw this.createCharUnknownErr(e);if(!this.gridTilemap)throw this.createUninitializedErr();let l=new t5(a,this.gridTilemap,h,o.distance,o.closestPointIfBlocked?"CLOSEST_REACHABLE":"STOP",o.maxPathLength);a.setMovement(l)}isMoving(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.isMoving()}getFacingDirection(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getFacingDirection()}getFacingPosition(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);let r=i.getFacingPosition();return{x:r.x,y:r.y}}turnTowards(t,e){var i;this.initGuard();let r=null==(i=this.gridCharacters)?void 0:i.get(t);if(!r)throw this.createCharUnknownErr(t);return r.turnTowards(e)}getCharactersAt(t,e){return this.gridTilemap?Array.from(this.gridTilemap.getCharactersAt(new T(t),e)).map(t=>t.getId()):[]}setPosition(t,e,i){var r;this.initGuard();let n=null==(r=this.gridCharacters)?void 0:r.get(t);if(!n)throw this.createCharUnknownErr(t);i||n.setTilePosition({position:new T(e),layer:n.getTilePos().layer}),n.setTilePosition({position:new T(e),layer:i})}isBlocked(t,e,i=["geDefault"]){var r,n;this.initGuard();let s=new T(t);return!!(null!=(r=this.gridTilemap)&&r.hasBlockingTile(s,e)||null!=(n=this.gridTilemap)&&n.hasBlockingChar(s,e,i))}isTileBlocked(t,e){var i;return this.initGuard(),!!(null!=(i=this.gridTilemap)&&i.hasBlockingTile(new T(t),e))}getCollisionGroups(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getCollisionGroups()||[]}setCollisionGroups(t,e){var i;this.initGuard();let r=null==(i=this.gridCharacters)?void 0:i.get(t);if(!r)throw this.createCharUnknownErr(t);r.setCollisionGroups(e)}getTilePosInDirection(t,e,i){if(!this.gridTilemap)throw this.createUninitializedErr();let r=this.gridTilemap.getTilePosInDirection({position:new T(t),layer:e},i);return{position:r.position.toPosition(),charLayer:r.layer}}findShortestPath(t,e,i={}){if(!this.gridTilemap)throw this.createUninitializedErr();let r=new t0(i.shortestPathAlgorithm||"BFS",this.gridTilemap).findShortestPath(P.toInternal(t),P.toInternal(e),i);return{path:r.path.map(P.fromInternal),closestToTarget:P.fromInternal(r.closestToTarget),reachedMaxPathLength:!1}}steppedOn(t,e,i){return this.positionChangeFinished().pipe(tA(r=>t.includes(r.charId)&&e.some(t=>t.x===r.enterTile.x&&t.y===r.enterTile.y)&&(void 0===i||i.includes(r.enterLayer))))}characterShifted(){if(!this.charAdded$||!this.charRemoved$)throw this.createUninitializedErr();return this.charAdded$.pipe(tL(t=>({charId:t,action:"ADDED"})),function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return tI.apply(void 0,M([],L(t)))}(this.charRemoved$.pipe(tL(t=>({charId:t,action:"REMOVED"})))))}movementStarted(){if(!this.movementStarted$)throw this.createUninitializedErr();return this.movementStarted$}movementStopped(){if(!this.movementStopped$)throw this.createUninitializedErr();return this.movementStopped$}directionChanged(){if(!this.directionChanged$)throw this.createUninitializedErr();return this.directionChanged$}positionChangeStarted(){if(!this.positionChangeStarted$)throw this.createUninitializedErr();return this.positionChangeStarted$}positionChangeFinished(){if(!this.positionChangeFinished$)throw this.createUninitializedErr();return this.positionChangeFinished$}getMovementProgress(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getMovementProgress()}charRemoved(t){var e;if(!this.charRemoved$)throw this.createUninitializedErr();return null==(e=this.charRemoved$)?void 0:e.pipe(tk(1),tA(e=>e==t))}initGuard(){if(!this.isCreatedInternal)throw this.createUninitializedErr()}createUninitializedErr(){throw Error("GridEngine not initialized. You need to call create() first.")}addCharacters(){var t;null==(t=this.config)||t.characters.forEach(t=>this.addCharacter(t))}moveChar(t,e){var i,r,n;this.initGuard();let s=null==(i=this.gridCharacters)?void 0:i.get(t);if(!s)throw this.createCharUnknownErr(t);if(4===s.getNumberOfDirections()){if(!(null!=(r=this.gridTilemap)&&r.isIsometric())&&C(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction mode.`);return}if(null!=(n=this.gridTilemap)&&n.isIsometric()&&!C(e)){console.warn(`GridEngine: Character '${t}' can't be moved '${e}' in 4 direction isometric mode.`);return}}s.move(e)}createCharUnknownErr(t){return Error(`Character unknown: ${t}`)}assembleMoveToConfig(t={}){let e=v(y({},t),{noPathFoundStrategy:"STOP",pathBlockedStrategy:"WAIT"});return null!=t&&t.noPathFoundStrategy&&(Object.values(t$).includes(t.noPathFoundStrategy)?e.noPathFoundStrategy=t.noPathFoundStrategy:console.warn(`GridEngine: Unknown NoPathFoundStrategy '${t.noPathFoundStrategy}'. Falling back to 'STOP'`)),null!=t&&t.pathBlockedStrategy&&(Object.values(tj).includes(t.pathBlockedStrategy)?e.pathBlockedStrategy=t.pathBlockedStrategy:console.warn(`GridEngine: Unknown PathBlockedStrategy '${t.pathBlockedStrategy}'. Falling back to 'WAIT'`)),e}setConfigDefaults(t){return y({collisionTilePropertyName:"ge_collide",numberOfDirections:4,characterCollisionStrategy:"BLOCK_TWO_TILES"},t)}},es=class{constructor(t){this.tilemap=t,this.charLayerDepths=new Map,this.setLayerDepths()}getTileWidth(){var t,e;let i=null!=(e=null==(t=this.tilemap.layers[0])?void 0:t.tilemapLayer.scale)?e:1;return this.tilemap.tileWidth*i}getTileHeight(){var t,e;let i=null!=(e=null==(t=this.tilemap.layers[0])?void 0:t.tilemapLayer.scale)?e:1;return this.tilemap.tileHeight*i}getDepthOfCharLayer(t){var e;return null!=(e=this.charLayerDepths.get(t))?e:0}tilePosToPixelPos(t){return this.isIsometric()?tU.scalarMult(this.getTileSize(),.5).multiply(new T(t.x-t.y,t.x+t.y)):t.clone().multiply(this.getTileSize())}getTileDistance(t){if(this.isIsometric())switch(t){case"down-left":case"down-right":case"up-left":case"up-right":return tU.scalarMult(this.getTileSize(),.5)}return this.getTileSize()}getTileSize(){return new T(this.getTileWidth(),this.getTileHeight())}isIsometric(){return this.tilemap.orientation==Phaser.Tilemaps.Orientation.ISOMETRIC.toString()}isLayerAlwaysOnTop(t){return this.hasLayerProp(t,es.ALWAYS_TOP_PROP_NAME)}isCharLayer(t){return this.hasLayerProp(t,es.CHAR_LAYER_PROP_NAME)}setLayerDepths(){let t=[],e=-1,i=this.tilemap.layers.filter(t=>this.isLayerAlwaysOnTop(t));this.tilemap.layers.filter(t=>!this.isLayerAlwaysOnTop(t)).forEach(i=>{this.hasLayerProp(i,es.HEIGHT_SHIFT_PROP_NAME)?(this.createHeightShiftLayers(i,e),t.push(i.tilemapLayer)):this.setDepth(i,++e)}),this.charLayerDepths.set(void 0,e),i.forEach((t,i)=>{t.tilemapLayer.setDepth(i+1+e)}),t.forEach(t=>t.destroy())}setDepth(t,e){t.tilemapLayer.setDepth(e),this.isCharLayer(t)&&this.charLayerDepths.set(this.getLayerProp(t,es.CHAR_LAYER_PROP_NAME),e)}createHeightShiftLayers(t,e){let i=this.getLayerProp(t,es.HEIGHT_SHIFT_PROP_NAME);isNaN(i)&&(i=0);for(let r=0;r<t.height;r++){let n=this.copyLayer(t,r);n.scale=t.tilemapLayer.scale,n.setDepth(e+tN.shiftPad((r+i)*this.getTileHeight()+1,es.Z_INDEX_PADDING))}}getLayerProp(t,e){let i=t.properties.find(t=>t.name==e);return null==i?void 0:i.value}hasLayerProp(t,e){return null!=this.getLayerProp(t,e)}copyLayer(t,e){let i=`${t.name}#${e}`,r=this.tilemap.createBlankLayer(i,t.tilemapLayer.tileset);r.name=i;for(let i=0;i<t.width;i++)r.putTileAt(t.data[e][i],i,e);return r}},eo=es;eo.ALWAYS_TOP_PROP_NAME="ge_alwaysTop",eo.CHAR_LAYER_PROP_NAME="ge_charLayer",eo.HEIGHT_SHIFT_PROP_NAME="ge_heightShift",eo.Z_INDEX_PADDING=7;var ea=class{constructor(t){this.phaserTile=t}getProperty(t){return this.phaserTile.properties[t]}hasProperty(t){return null!=this.getProperty(t)}},eh=class{constructor(t){this.phaserTilemapLayer=t}getName(){return this.phaserTilemapLayer.layer.name}getProperty(t){let e=this.phaserTilemapLayer.layer.properties,i=null==e?void 0:e.find(e=>e.name==t);return null==i?void 0:i.value}hasProperty(t){return null!=this.getProperty(t)}isCharLayer(){return this.hasProperty(et)}getData(){return this.phaserTilemapLayer.layer.data.map(t=>t.map(t=>new ea(t)))}},el=class{constructor(t){this.phaserTilemap=t}getTileWidth(){return this.phaserTilemap.tileWidth}getTileHeight(){return this.phaserTilemap.tileHeight}getWidth(){return this.phaserTilemap.width}getHeight(){return this.phaserTilemap.height}getOrientation(){return this.phaserTilemap.orientation==Phaser.Tilemaps.Orientation.ISOMETRIC.toString()?"isometric":"orthogonal"}getLayers(){return this.phaserTilemap.layers.map(t=>new eh(t.tilemapLayer))}hasTileAt(t,e,i){return!!this.phaserTilemap.hasTileAt(t,e,i)}getTileAt(t,e,i){if(this.phaserTilemap.getTileAt(t,e,!1,i))return new ea(this.phaserTilemap.getTileAt(t,e,!1,i))}},ec=class{constructor(t){this.scene=t,this.geHeadless=new en,this.isCreatedInternal=!1,console.log(`Using GridEngine Phaser Plugin v${t4}`),this.scene.sys.events.once("boot",this.boot,this)}boot(){this.scene.sys.events.on("update",this.update,this)}getCharLayer(t){return this.geHeadless.getCharLayer(t)}getTransition(t,e){return this.geHeadless.getTransition(t,e)}setTransition(t,e,i){this.geHeadless.setTransition(t,e,i)}create(t,e){this.geHeadless.create(new el(t),e),this.isCreatedInternal=!0,this.gridCharacters=new Map;let i=this.setConfigDefaults(e);this.config=i,this.gridTilemap=new eo(t),this.addCharacters()}getPosition(t){return this.geHeadless.getPosition(t)}move(t,e){this.geHeadless.move(t,e)}moveRandomly(t,e=0,i=-1){this.geHeadless.moveRandomly(t,e,i)}getMovement(t){return this.geHeadless.getMovement(t)}moveTo(t,e,i){return this.geHeadless.moveTo(t,e,i)}stopMovement(t){this.geHeadless.stopMovement(t)}setSpeed(t,e){this.geHeadless.setSpeed(t,e)}getSpeed(t){return this.geHeadless.getSpeed(t)}getContainer(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getContainer()}getOffsetX(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getOffsetX()}getOffsetY(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getOffsetY()}collidesWithTiles(t){return this.geHeadless.collidesWithTiles(t)}getWalkingAnimationMapping(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);let r=i.getAnimation();return null==r?void 0:r.getWalkingAnimationMapping()}hasLayerOverlay(){var t;return this.initGuard(),!!(null!=(t=this.config)&&t.layerOverlay)}setWalkingAnimationMapping(t,e){var i;this.initGuard();let r=null==(i=this.gridCharacters)?void 0:i.get(t);if(!r)throw this.createCharUnknownErr(t);let n=r.getAnimation();null==n||n.setWalkingAnimationMapping(e)}update(t,e){if(this.isCreatedInternal&&this.gridCharacters)for(let[t,i]of this.gridCharacters)i.update(e);this.geHeadless.update(t,e)}addCharacter(t){this.geHeadless.addCharacter(t),this.addCharacterInternal(t)}hasCharacter(t){return this.geHeadless.hasCharacter(t)}removeCharacter(t){var e,i;this.initGuard();let r=null==(e=this.gridCharacters)?void 0:e.get(t);if(!r)throw this.createCharUnknownErr(t);r.destroy(),null==(i=this.gridCharacters)||i.delete(t),this.geHeadless.removeCharacter(t)}removeAllCharacters(){if(this.initGuard(),this.gridCharacters){for(let t of this.gridCharacters.keys())this.removeCharacter(t);this.geHeadless.removeAllCharacters()}}getAllCharacters(t){return this.geHeadless.getAllCharacters(t)}getLabels(t){return this.geHeadless.getLabels(t)}addLabels(t,e){this.geHeadless.addLabels(t,e)}removeLabels(t,e){this.geHeadless.removeLabels(t,e)}clearLabels(t){this.geHeadless.clearLabels(t)}follow(t,e,i,r){let n;void 0===i?n={distance:0,closestPointIfBlocked:!1}:"number"==typeof i?(n={distance:i,closestPointIfBlocked:!1},r&&(n.closestPointIfBlocked=!0)):n=i,this.geHeadless.follow(t,e,n)}isMoving(t){return this.geHeadless.isMoving(t)}getFacingDirection(t){return this.geHeadless.getFacingDirection(t)}getFacingPosition(t){return this.geHeadless.getFacingPosition(t)}turnTowards(t,e){var i;this.initGuard();let r=null==(i=this.gridCharacters)?void 0:i.get(t);if(!r)throw this.createCharUnknownErr(t);r.turnTowards(e),this.geHeadless.turnTowards(t,e)}getCharactersAt(t,e){return this.geHeadless.getCharactersAt(t,e)}setPosition(t,e,i){this.geHeadless.setPosition(t,e,i)}getSprite(t){var e;this.initGuard();let i=null==(e=this.gridCharacters)?void 0:e.get(t);if(!i)throw this.createCharUnknownErr(t);return i.getSprite()}setSprite(t,e){var i;this.initGuard();let r=null==(i=this.gridCharacters)?void 0:i.get(t);if(!r)throw this.createCharUnknownErr(t);e.setOrigin(0,0),this.setCharSprite(e,r)}isBlocked(t,e,i=["geDefault"]){return this.geHeadless.isBlocked(t,e,i)}isTileBlocked(t,e){return this.geHeadless.isTileBlocked(t,e)}getCollisionGroups(t){return this.geHeadless.getCollisionGroups(t)}setCollisionGroups(t,e){this.geHeadless.setCollisionGroups(t,e)}getTilePosInDirection(t,e,i){return this.geHeadless.getTilePosInDirection(t,e,i)}findShortestPath(t,e,i={}){return this.geHeadless.findShortestPath(t,e,i)}steppedOn(t,e,i){return this.geHeadless.steppedOn(t,e,i)}characterShifted(){return this.geHeadless.characterShifted()}movementStarted(){return this.geHeadless.movementStarted()}movementStopped(){return this.geHeadless.movementStopped()}directionChanged(){return this.geHeadless.directionChanged()}positionChangeStarted(){return this.geHeadless.positionChangeStarted()}positionChangeFinished(){return this.geHeadless.positionChangeFinished()}getMovementProgress(t){return this.geHeadless.getMovementProgress(t)}setConfigDefaults(t){return y({collisionTilePropertyName:"ge_collide",numberOfDirections:4,characterCollisionStrategy:"BLOCK_TWO_TILES",layerOverlay:!1},t)}initGuard(){if(!this.isCreatedInternal)throw this.createUninitializedErr()}createUninitializedErr(){throw Error("GridEngine not initialized. You need to call create() first.")}addCharacters(){var t;null==(t=this.config)||t.characters.forEach(t=>this.addCharacterInternal(t))}createCharUnknownErr(t){return Error(`Character unknown: ${t}`)}setCharSprite(t,e){e.setSprite(t)}addCharacterInternal(t){var e;if(this.initGuard(),!this.gridTilemap||!this.config)throw this.createUninitializedErr();let i=new tG(t,this.scene,this.gridTilemap,this.config.layerOverlay,this.geHeadless);null==(e=this.gridCharacters)||e.set(t.id,i)}},eu=ec}}]);